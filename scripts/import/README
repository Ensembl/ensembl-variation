Populating an Ensembl Variation database with data from DBSNP
======================================================================

Checkout required scripts and APIs
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Set the working directory

  $ cd /some/path/to/workdir
  $ setenv BASEDIR $PWD

Get bioperl code

  $ cvs -d :pserver:cvs@cvs.open-bio.org:/home/repository/bioperl login
    (pass cvs)

  $ cvs -d :pserver:cvs@cvs.open-bio.org:/home/repository/bioperl \
    co bioperl-live 

Get ensembl-core code

  $ cvs -d :ext:cvs.sanger.ac.uk:/cvsroot/ensembl co ensembl

Get ensembl-variation code

  $ cvs -d :ext:cvs.sanger.ac.uk:/cvsroot/ensembl co ensembl-variation

Get ensembl-analysis code

  $ cvs -d :ext:cvs.sanger.ac.uk:/cvsroot/ensembl co ensembl-pipeline

Get ensembl-personal code (code may move to ensembl-variation in future)

  $ cvs -d :ext:cvs.sanger.ac.uk:/cvsroot/ensembl co ensembl-personal

Set the Perl environment

  $ setenv PERL5LIB ${BASEDIR}/bioperl-live:${PERL5LIB}
  $ setenv PERL5LIB ${BASEDIR}/ensembl/modules:${PERL5LIB}
  $ setenv PERL5LIB ${BASEDIR}/ensembl-variation/modules:${PERL5LIB}
  $ setenv PERL5LIB ${BASEDIR}/ensembl-analysis/modules:${PERL5LIB}
  $ setenv PERL5LIB ${BASEDIR}/ensembl-personal/yuan:${PERL5LIB}
  

Configure databases
~~~~~~~~~~~~~~~~~~~
Variation databases are created on a per-species basis. Pick a mysql
instance and create an empty ensembl variation database;

  $ setenv var_db ${USER}_homo_sapiens_variation_test
  $ setenv var_host myhost
  $ setenv var_port 3306
  $ setenv var_user ${USER}
  $ setenv var_pass secret
  $ mysql \
    --host=${var_host} --port=${var_port}     \
    --user=${var_user} --password=${var_pass} \
    -e "create database ${var_db}"

And load the schema;

  $ mysql \
    --host=${var_host} --port=${var_port}     \
    --user=${var_user} --password=${var_pass} \
    ${var_db} < $BASEDIR/ensembl-variation/sql/table.sql

In addition to the new variation database, a core ensembl database and
an import of the dbSNP database are also required;

  $ setenv core_db homo_sapiens_core_32_35a
  $ setenv core_host myhost
  $ setenv core_port 3306
  $ setenv core_user ${USER}
  $ mysql \
    --host=${core_host} --port=${core_port}     \
    --user=${core_user} --password=${core_pass} \
    -e "show tables" ${core_db}

  $ setenv snp_db dbsnp_124
  $ setenv snp_host myhost
  $ setenv snp_port 3306
  $ setenv core_user ${USER}
  $ mysql \
    --host=${snp_host} --port=${snp_port}     \
    --user=${snp_user} --password=${snp_pass} \
    -e "show tables" ${snp_db}


Configure import script
~~~~~~~~~~~~~~~~~~~~~~~
Go to script dir;

  $ cd $BASEDIR/ensembl-variation/ensembl-variation/scripts/import/


Look at the following file, and determine whether an appropriate
SPECIES_PREFIX is configured;

  $ <editor> dbSNP.pl

Add a new "if ($SPECIES_PREFIX eq 'xx')" block if required. The most
basic, used for importing variations (e.g. SNPs) and flanking
sequences only may resemble;

  my $dbsnp = dbSNP::GenericContig->new(-dbSNP => $dbSNP,
                                        -dbCore => $dbCore,
                                        -dbVariation => $dbVar,
                                        -tmpdir => $TMP_DIR,
                                        -tmpfile => $TMP_FILE,
                                        -limit => $LIMIT_SQL,
                                        -taxID => $TAX_ID,
                                        -species_prefix => $SPECIES_PREFIX
                                        );
  $dbsnp->dump_dbSNP();



Run import script
~~~~~~~~~~~~~~~~~
Go to script dir;

  $ cd $BASEDIR/ensembl-variation/scripts/import/

Make sure dbSNP.pl script can run (should get usage info);

  $ /path/to/perl dbSNP.pl

Make sure dbSNP.pl script can run over lsf (more usage info);

  $bsub -I /path/to/perl dbSNP.pl

Run the import script for real;

  $ bsub -e errors.txt -o dbSNP_output.txt                      \
    -K /path/to/perl dbSNP.pl                                   \
    -dsdbname=${snp_db}                                         \
    -dshost=${snp_host} -dsport=${snp_port} -dsuser=${snp_user} \
    -cdbname ${core_db}                                         \
    -chost=${core_host} -cport=${core_port} -cuser=${core_user} \
    -vdbname ${var_db}                                          \
    -vhost=${var_host} -vport=${var_port} -vuser=${var_user}    \
    -tmpdir=/tmp -tmpfile=temp_file.txt

Check the errors.txt file for, erm, errors?

  $ cat errors.txt


Mapping dbSNP flanking sequences to the genome
==============================================

This procedure is not required if the dbSNP database already contains
the mappings between the species of interest and the specific assembly
in the ensembl code DB. If the data is missing, or the mappings are to
a different assembly, then the flanks must be mapped to the genopme
using SSAHA, and the results loaded into the variation DB.


Dump the flanking sequences into a text file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Go to the script dir;

  $ cd $BASEDIR/ensembl-personal/yuan/snp/scripts

Run the input file generation program. This will generate a fasta file
per 10000 SNPs in the current working dir;

  $ bsub -e bsub_errors.txt -o bsub_output.txt                  \
    -K /path/to/perl generate_input_seq.pl                      \
    -cdbname=${core_db} -chost=${core_host} -cport=${core_port} \
    -cuser=${core_user} -cpass=${core_pass}                     \
    -vdbname ${var_db} -vhost=${var_host} -vport=${var_port}    \
    -vuser=${var_user} -vpass=${var_pass}

Finally, move the query_seq files into an appropriate dir, e.g.;

  $ mkdir -p $BASEDIR/data/oryza_sativa/fasta/snp
  $ cd $BASEDIR/data/oryza_sativa/fasta/snp
  $ mv $BASEDIR/ensembl-personal/yuan/snp/scripts/*_query_seq .


Prepare the target sequence
~~~~~~~~~~~~~~~~~~~~~~~~~~~
The target sequence comprise of fasta files, one per chromosome for
the target species, in a single directory. The files should be named
1.fa, 2.fa etc. If the files are not already available, they will need
to be dumped from the core ensembl database.


Generate the ssaha alignments
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Make sure that the following file exists

 $ ls $BASEDIR/ensembl-analysis/modules/Bio/EnsEMBL/Analysis/Config/General.pm

If not, copy the General.pm.example file, and check that %Config is
correct for your system.

Go to the following script dir

  $ cd $BASEDIR/ensembl-personal/yuan/snp/scripts

Run the bsub_ssaha script. The following example will cause the first
10 snp chunk files to be aligned against the target sequence using
ssaha. A second crossmatch step extends the seeds generated by ssaha
by alignment with the genome.

  $ /usr/local/ensembl/perl bsub_ssaha.pl /
  -input_dir $BASEDIR/data/fasta/snp /
  -target_dir $BASEDIR/data/fasta/dna /
  -cdbname ${var_db} /
  -ssaha_here        /
  -start 1 -end 10

The runs typically takes several hours. Check the bsub output and
error files after the job completed to ensure that it was
successful. These are out_N and error_N, and can be very large. Keep
an eye on free disk space and clean up as needed. Rerun failed jobs
using bsub_ssaha's -start and -end params. The end product will be a
set of map_N_query_seq files containing the filtered, processed snp
locations. Note; the proportion of SNPs that maped is indicated at the
end of the out_N file. 


Load the SNP features into the Variation DB
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Concatenate all mapping files into a single file;

  $ cat map_*_ > map_ALL_

Go to the following script dir;

  $ cd $BASEDIR/ensembl-variation/scripts/import

Run the following script;

  $ bsub -o out_load_mapping -e error_load_mapping              \
    /path/to/perl load_mapping2vf.pl                            \
    -cdbname=${core_db} -chost=${core_host} -cport=${core_port} \
    -cuser=${core_user} -cpass=${core_pass}                     \
    -vdbname ${var_db} -vhost=${var_host} -vport=${var_port}    \
    -vuser=${var_user} -vpass=${var_pass}                       \
    -alldiff $BASEDIR/ensembl-personal/yuan/snp/scripts/map_<N>_query_seq

    




